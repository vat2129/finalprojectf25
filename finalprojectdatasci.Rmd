---
title: "finalprojectcode"
author: "vat2129"
date: "2025-12-09"
output:
  html_document: default
  pdf_document: default
---
```{r setup, include=FALSE}
```

Libraries & Set Up
```{r setup, include=FALSE}
library(tidyverse)
library(shiny)
library(dplyr)
library(foreign)
library(tidyr)
library(ggplot2)
library(maps)
library(stringr)
library(usmap)
library(gganimate)
library(gifski)
library(Hmisc)
```

Data Cleaning/Consolidating
```{r}
bigclimatedata <- foreign::read.spss("~/datasci01/data/CCAM SPSS Data 2008-2024.sav", 
                                     to.data.frame=TRUE)

#here we are funneling the data into the pieces that will be pertinent to our analysis
climatedata <- bigclimatedata %>% 
  select(case_ID, wave, weight_wave, weight_aggregate, year, happening, worry, party_w_leaners, region9, educ, gender, race,
         educ_category, age, age_category, income, income_category, generation,
         starts_with("harm")) %>% 
  mutate(party_w_leaners = case_when(
    party_w_leaners == "Refused" ~ "Independent/Other",
    party_w_leaners == "No party/Not interested in politics" ~ "Independent/Other",
    TRUE ~ party_w_leaners)) %>%
  mutate(across(starts_with("harm"), ~case_when(
    . == "Don't know" ~ NA, 
    . == "Not at all" ~ 1,
    . == "Only a little" ~ 2,
    . == "A moderate amount" ~ 3,
    . == "A great deal" ~ 4,
    . == "Refused" ~ NA))) %>%
  mutate(worry = case_when(
    worry == "Not at all worried" ~ 1,
    worry == "Not very worried" ~ 2,
    worry == "Somewhat worried" ~ 3,
    worry == "Very worried" ~ 4,
    worry == "Refused" ~ NA)) %>%
  mutate(harm_worry = worry) %>%
  mutate(non_na_count = rowSums(!is.na(across(starts_with("harm"))))) %>% 
  filter((wave == "Oct 2015" & non_na_count >= 5) | 
         (wave != "Oct 2015" & non_na_count >= 6)) %>% 
  mutate(concern_score = rowMeans(across(starts_with("harm")), na.rm = TRUE))

```
"Don't Know"
```{r}
dkdata <- bigclimatedata %>% 
  select(case_ID, wave, weight_wave, weight_aggregate, year, happening, worry,
         party_w_leaners, region9, educ, gender, race,
         educ_category, age, age_category, income, income_category, generation,
         starts_with("harm")) %>%
  mutate(dk_count = rowSums(across(starts_with("harm"), ~ . == "Don't know"), na.rm = TRUE),
    any_dk = dk_count > 0) %>%
  mutate(party_w_leaners = case_when(
    party_w_leaners == "Refused" ~ "Independent/Other",
    party_w_leaners == "No party/Not interested in politics" ~ "Independent/Other",
    TRUE ~ party_w_leaners))

dkm <- lm(any_dk ~ age + region9 + race + income_category + educ_category +
     party_w_leaners + year,data = dkdata, weights = weight_aggregate)
summary(dkm)
  
```

Demographic Table
```{r}
demographic_vars <- c("gender", "race", "educ_category", "age_category", 
               "income_category", "party_w_leaners", "region9")

demographic_table <- climatedata %>%
  pivot_longer(cols = all_of(demographic_vars), names_to = "variable", values_to = "category") %>%
  group_by(variable, category) %>%
  summarise(n = n(), 
            weightedpercent = round(100 * sum(weight_aggregate, na.rm = TRUE) /
              sum(climatedata$weight_aggregate, na.rm = TRUE), 1),
            avg.concern = round(weighted.mean(concern_score, weight_aggregate, na.rm =     
              TRUE), 2),
            sd.concern = round(sqrt(wtd.var(concern_score, weight_aggregate, na.rm =     
              TRUE)), 2),
            .groups = "drop_last") %>%
  arrange(variable, desc(weightedpercent)) %>%
  group_by(variable) %>%
  mutate(variable = if_else(row_number() == 1, variable, ""),
         category = as.character(category)) %>%
  ungroup() %>%
  select(variable, category, n, weightedpercent, avg.concern, sd.concern) %>%
  mutate(variable = recode(
    variable,
    gender = "Gender",
    race = "Race",
    educ_category = "Education",
    age_category = "Age",
    income_category = "Income",
    party_w_leaners = "Party",
    region9 = "Region")) %>%
  rename("Number of Respondents" = n, 
         "Average Concern Score" =  avg.concern,
         "Weighted Percentage" = weightedpercent,
         "Demographic Variable" = variable,
         "Category" = category)

 demographic_table
 
```

Statistical Analysis - Weighted/Non-Weighted Linear Regression Model
```{r}
#Main Analysis 
weighted.model <- lm(concern_score ~ age + region9 + income_category + 
              educ_category + party_w_leaners + year, data = climatedata, 
              weights = weight_aggregate)
weighted.model
summary(weighted.model)

```
Robustness Check
```{r}
#Analysis without weights 
unweighted.model <- lm(concern_score ~ age + region9 + income_category + educ_category + 
              party_w_leaners + year, data = climatedata)
unweighted.model
summary(unweighted.model)

#Weighted analyis of worry 
model <- lm(harm_worry ~ age + region9 + income_category + educ_category + 
              party_w_leaners + year, data = climatedata,  weights = weight_aggregate)
model
summary(model)
```

FIGURE: Mean Concern Over Time by Party (line graph)
```{r}
concern_trends <- climatedata %>%
  group_by(year, party_w_leaners) %>%
  summarise(
    #calulate a weighted average
    mean_concern_score = weighted.mean(concern_score, w = weight_aggregate, na.rm = TRUE),
    n = n(),
    .groups = 'drop') %>%
  #remove NA 
  filter(!is.na(party_w_leaners))

concern_trends %>% 
  ggplot(aes(x = year, y = mean_concern_score, group = party_w_leaners)) +
  geom_line(aes(color = party_w_leaners)) +
  scale_color_manual(
    values = c("Democrats" = "blue",
      "Republicans" = "red",
      "Independent/Other" = "purple")) +
  labs(title = "Mean Concern Over Time by Party",
      x = "Year", y = "Mean Concern Score") 
```


Climate Concern by Region (map still)
```{r}
#here is a more general look of the various parties concern of climate change (not factoring in time)
region_party_scores <- climatedata %>%
  group_by(region9) %>%
  summarise(mean_concern = weighted.mean(concern_score, w = weight_aggregate, na.rm = TRUE), 
    .groups = 'drop') 

region_states <- tibble(
  state = state.abb,
  region9 = case_when(
    state %in% c("CT","MA","ME","NH","RI","VT") ~ "New England",
    state %in% c("NJ","NY","PA") ~ "Mid-Atlantic",
    state %in% c("IL","IN","MI","OH","WI") ~ "East-North Central",
    state %in% c("IA","KS","MN","MO","ND","NE","SD") ~ "West-North Central",
    state %in% c("DC","DE","FL","GA","MD","NC","SC","VA","WV") ~ "South Atlantic",
    state %in% c("AL","KY","MS","TN") ~ "East-South Central",
    state %in% c("AR","LA","OK","TX") ~ "West-South Central",
    state %in% c("AZ","CO","ID","MT","NM","NV","UT","WY") ~ "Mountain",
    state %in% c("AK","CA","HI","OR","WA") ~ "Pacific",
    TRUE ~ NA))

map_df <- region_states %>%
  left_join(region_party_scores, by = "region9")

plot_usmap(data = map_df,
  values = "mean_concern",
  color = "white") +
  scale_fill_continuous(name = "Climate Concern", label = scales::comma) +
  scale_fill_viridis_c() +
  labs(title = "Climate Concern Score by Region") +
  theme(legend.position = "right")
```
FIGURE: Evolution of Climate Concern by U.S. Region (map gif)
```{r}
#here is the general map over time (all parties)
region_scores_time <- climatedata %>%
  mutate(year = as.integer(year)) %>%
  group_by(year, region9) %>%
  #calculate the weighted mean concern score
  summarise(mean_concern = weighted.mean(concern_score, w = weight_aggregate, na.rm = TRUE), 
    .groups = 'drop') %>%
  complete(year, region9) %>%
  #remove rows where a region/year combination resulted in NA mean concern
  filter(!is.na(mean_concern))

#to create the visual we had to create a table such that the map fcn could understand the regions
region_states <- tibble(state = state.abb,
  region9 = case_when(state %in% c("CT","MA","ME","NH","RI","VT") ~ "New England",
    state %in% c("NJ","NY","PA") ~ "Mid-Atlantic",
    state %in% c("IL","IN","MI","OH","WI") ~ "East-North Central",
    state %in% c("IA","KS","MN","MO","ND","NE","SD") ~ "West-North Central",
    state %in% c("DC","DE","FL","GA","MD","NC","SC","VA","WV") ~ "South Atlantic",
    state %in% c("AL","KY","MS","TN") ~ "East-South Central",
    state %in% c("AR","LA","OK","TX") ~ "West-South Central",
    state %in% c("AZ","CO","ID","MT","NM","NV","UT","WY") ~ "Mountain",
    state %in% c("AK","CA","HI","OR","WA") ~ "Pacific",
    TRUE ~ NA_character_))

map_df_time <- region_states %>%
  left_join(region_scores_time, by = "region9", relationship = "many-to-many") %>%
  filter(!is.na(region9))

#the base plot for the US map
base_map_plot <- plot_usmap(data = map_df_time, values = "mean_concern", color = "white") +
  
  #construct the fill scale
  scale_fill_continuous(
    name = "Mean Climate Concern Score",
    limits = c(min(map_df_time$mean_concern, na.rm = TRUE), 
               max(map_df_time$mean_concern, na.rm = TRUE))) +
  scale_fill_viridis_c() +
  #labels and title
  labs(title = "Evolution of Climate Concern by U.S. Region",
    #so the graph shows the wave its showing 
    subtitle = "Year: {closest_state}") +
  #make sure it is clearly legible
  theme(legend.position = "right",
    plot.title = element_text(hjust = 0.5),
    plot.subtitle = element_text(hjust = 0.5, face = "bold"))

#put it together
animated_map_plot <- base_map_plot +
  #this is what will create the cycling of the year
  transition_states(year, transition_length = 2, state_length = 1)


#animate(animated_map_plot, renderer = gifski_renderer(), nframes = 50, fps = 5, 
    #   width = 800, height = 500)
```

FIGURE: (Function) Evolution of Climate Concern by U.S. Region by Party (map gif)
```{r}
#as we were interested in understanding how concern changed by region across time, we created a visual that will show a map of the US each year that the survey ran and display the concern by party
make_party_animation <- function(party_name) {
  
  #we filter to be able to seperate by party
  party_data <- climatedata %>%
    filter(party_w_leaners == party_name) %>%
    mutate(year = as.integer(year)) %>%
    group_by(year, region9) %>%
    summarise(mean_concern = weighted.mean(concern_score, w = weight_aggregate, na.rm = TRUE),
              .groups = "drop")

  #join our states data with our party data
  party_map <- region_states %>%
    left_join(party_data, by = "region9", relationship = "many-to-many") %>%
    filter(!is.na(mean_concern))

  #fix the color scale 
  fill_limits <- range(party_map$mean_concern, na.rm = TRUE)

  #base map
  base_map <- plot_usmap( data = party_map, values = "mean_concern", color = "white") +
    scale_fill_continuous(name = "Mean Climate Concern Score", limits = fill_limits) + 
    scale_fill_viridis_c() +
    labs(title = paste0("Climate Concern by U.S. Region â€” ", party_name),
      subtitle = "Year: {frame_time}") +
    theme(legend.position = "right", plot.title = element_text(hjust = 0.5),
      plot.subtitle = element_text(hjust = 0.5, face = "bold"))

  #animation details
  animated_plot <- base_map + transition_time(year) + ease_aes("linear")

  animate(animated_plot, renderer = gifski_renderer(), nframes = 80, fps = 6,
          width = 800, height = 500, end_pause = 10)
}

#Figures 3, 4, & 5 Evolution of Climate Concern by U.S. Region by Party 
#anim_dem <- make_party_animation("Democrats")
#anim_rep <- make_party_animation("Republicans")
#anim_ind <- make_party_animation("Independent/Other")
```


